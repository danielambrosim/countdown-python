
{% extends "base.html" %}
{% block title %}{{ title }} â€¢ Contagem Regressiva{% endblock %}
{% block content %}
<section class="card">
  <div class="event-head">
    <h1 class="h1" id="evTitle">{{ title }}</h1>
    <div class="share">
      <button class="btn" id="copy">Copiar link</button>
      <span id="copyMsg" class="muted"></span>
    </div>
  </div>

  <div class="countdown" aria-live="polite">
    <div class="timebox"><div class="num" id="d">00</div><div class="lab">dias</div></div>
    <div class="timebox"><div class="num" id="h">00</div><div class="lab">horas</div></div>
    <div class="timebox"><div class="num" id="m">00</div><div class="lab">min</div></div>
    <div class="timebox"><div class="num" id="s">00</div><div class="lab">seg</div></div>
  </div>

  <div id="endBanner" class="end-banner">ðŸŽ‰ Fim da contagem! Evento iniciado/encerrado.</div>
  <canvas id="confetti"></canvas>
</section>

<script>
  const untilIso = "{{ until_iso }}";
  const serverNowIso = "{{ server_utc_now }}";
  const until = new Date(untilIso);
  const serverNow = new Date(serverNowIso);
  const drift = Date.now() - serverNow.getTime(); // diferenÃ§a cliente-servidor

  const dEl = document.getElementById('d');
  const hEl = document.getElementById('h');
  const mEl = document.getElementById('m');
  const sEl = document.getElementById('s');
  const endBanner = document.getElementById('endBanner');

  const copyBtn = document.getElementById('copy');
  const copyMsg = document.getElementById('copyMsg');
  copyBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(location.href);
      copyMsg.textContent = 'Link copiado!';
    } catch {
      copyMsg.textContent = 'Copie o link da barra do navegador.';
    }
    setTimeout(()=>{ if (copyMsg.textContent) copyMsg.textContent = ''; }, 2200);
  });

  let fired = false;
  let timer = null;

  function pad(n){ return String(n).padStart(2,'0'); }
  function setTime(d,h,m,s){
    dEl.textContent = pad(d);
    hEl.textContent = pad(h);
    mEl.textContent = pad(m);
    sEl.textContent = pad(s);
  }

  function msToParts(ms){
    const s = Math.floor(ms/1000);
    const d = Math.floor(s/86400);
    const h = Math.floor((s%86400)/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return {d,h,m, s:sec};
  }

  function tick(){
    const now = new Date(Date.now() - drift); // corrige com o relÃ³gio do servidor
    let diff = until.getTime() - now.getTime();
    if (diff <= 0){
      setTime(0,0,0,0);
      if (!fired){
        fired = true;
        endBanner.classList.add('show');
        celebrate();
      }
      return;
    }
    const {d,h,m,s} = msToParts(diff);
    setTime(d,h,m,s);
  }

  timer = setInterval(tick, 1000);
  tick();

  // --------------- Confetti (canvas) -----------------
  const canvas = document.getElementById('confetti');
  const ctx = canvas.getContext('2d');
  let confettiPieces = [];
  let confettiActive = false;

  function resize(){
    canvas.width = innerWidth;
    canvas.height = innerHeight;
  }
  addEventListener('resize', resize); resize();

  function celebrate(){
    confettiActive = true;
    spawn(300);
    let bursts = 0;
    const iv = setInterval(() => {
      spawn(150);
      bursts++;
      if (bursts > 6){
        clearInterval(iv);
        setTimeout(() => confettiActive = false, 2500);
      }
    }, 350);
    requestAnimationFrame(loop);
  }

  function spawn(n){
    for (let i=0; i<n; i++){
      confettiPieces.push({
        x: Math.random()*canvas.width,
        y: -20 - Math.random()*canvas.height*0.3,
        r: 2 + Math.random()*5,
        vx: -1 + Math.random()*2,
        vy: 3 + Math.random()*4,
        a: Math.random()*Math.PI*2,
        va: -0.2 + Math.random()*0.4,
        o: 0.8 + Math.random()*0.2
      });
    }
  }

  function loop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if (confettiActive){
      ctx.fillStyle = 'rgba(124,92,255,0.06)';
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }
    for (let i = confettiPieces.length - 1; i >= 0; i--){
      const p = confettiPieces[i];
      p.x += p.vx;
      p.y += p.vy;
      p.a += p.va;
      p.o *= 0.996;
      if (p.y > canvas.height + 30 || p.o < 0.02){
        confettiPieces.splice(i,1);
        continue;
      }
      ctx.save();
      ctx.globalAlpha = p.o;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.a);
      ctx.fillRect(-p.r, -p.r*0.4, p.r*2, p.r*0.8);
      ctx.restore();
    }
    if (confettiActive || confettiPieces.length > 0){
      requestAnimationFrame(loop);
    }
  }
</script>
{% endblock %}
